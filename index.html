<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food Truck</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: "Georgia", serif;
      background: linear-gradient(to right, #fff7e6, #ffe0b3);
    }

    /* Navbar styling */
    .navbar {
      margin-bottom: 20px;
    }

    .navbar-brand {
      font-weight: bold;
      color: #ff6e30 !important;
      font-size: 1.8rem;
    }

    /* Restaurant cards */
    .restaurant-card {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .restaurant-card:hover {
      transform: scale(1.03);
      box-shadow: 0 10px 24px rgba(0,0,0,0.2);
    }

    .restaurant-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .restaurant-card .info {
      padding: 15px;
    }

    .restaurant-card h3 {
      color: #ff6e30;
      font-weight: bold;
    }

    .restaurant-card p {
      margin: 5px 0;
    }

    /* Menu popup */
    .menu-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      padding: 2rem;
      z-index: 1000;
      max-width: 400px;
      width: 90%;
    }

    .menu-popup button {
      margin-top: 1rem;
      background: linear-gradient(90deg, #ff6e30 60%, #ffb347 100%);
      color: #fff;
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
    }

    /* Nearby button */
    #find-nearby {
      background: linear-gradient(90deg, #ff6e30 60%, #ffb347 100%);
      color: #fff;
      font-weight: bold;
      border: none;
    }

    #find-nearby:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="#">Food Truck</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="#">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="signup.html">Sign Up</a></li>
          <li class="nav-item">
            <button class="btn ms-2" id="find-nearby">Find Nearby Restaurants</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Restaurants List -->
  <div class="container">
    <h2 class="text-center mb-4" style="color:#ff6e30;">Our Restaurants</h2>
    <div class="row restaurant-list"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let restaurants = [];

    async function fetchRestaurants() {
      try {
        const res = await fetch('http://localhost:5000/api/restaurants');
        restaurants = await res.json();
        loadRestaurants();
      } catch(err) {
        console.error("Error fetching restaurants:", err);
        document.querySelector('.restaurant-list').innerHTML = '<p class="text-center text-danger">Failed to load restaurants.</p>';
      }
    }

    function loadRestaurants() {
      const list = document.querySelector('.restaurant-list');
      list.innerHTML = '';
      restaurants.forEach((r, idx) => {
        const col = document.createElement('div');
        col.className = 'col-md-4';
        const card = document.createElement('div');
        card.className = 'restaurant-card';
        card.innerHTML = `
          <img src="${r.image}" alt="${r.name}">
          <div class="info">
            <h3>${r.name}</h3>
            <p>${r.cuisine}</p>
            <button class="btn w-100 mt-2" onclick="showMenu(${idx})">View Menu</button>
          </div>
        `;
        col.appendChild(card);
        list.appendChild(col);
      });
    }

    function showMenu(idx) {
      const restaurant = restaurants[idx];
      fetch(`http://localhost:5000/api/restaurants/${restaurant._id}/menu`)
        .then(res => res.json())
        .then(menu => {
          let menuHtml = `<h3>${restaurant.name} Menu</h3><ul style='list-style:none;padding:0;'>`;
          menu.forEach(item => {
            menuHtml += `<li style='margin-bottom:10px;'>
              <span style='font-weight:500;'>${item.name}</span> - â‚¹${item.price}
            </li>`;
          });
          menuHtml += '</ul>';
          const menuSection = document.createElement('div');
          menuSection.className = 'menu-popup';
          menuSection.innerHTML = menuHtml + `<button onclick="this.parentElement.remove()">Close</button>`;
          document.body.appendChild(menuSection);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchRestaurants();

      const nearbyBtn = document.getElementById('find-nearby');
      if (nearbyBtn) {
        nearbyBtn.addEventListener('click', function() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
              const userLat = pos.coords.latitude;
              const userLng = pos.coords.longitude;
              showNearbyRestaurants(userLat, userLng);
            }, function() {
              alert('Location access denied.');
            });
          } else {
            alert('Geolocation not supported.');
          }
        });
      }
    });

    function showNearbyRestaurants(userLat, userLng) {
      const list = document.querySelector('.restaurant-list');
      list.innerHTML = '';
      restaurants.forEach((r, idx) => {
        if (!r.location) return;
        const dist = getDistanceFromLatLonInKm(userLat, userLng, r.location.lat, r.location.lng);
        if (dist <= 50) {
          const col = document.createElement('div');
          col.className = 'col-md-4';
          const card = document.createElement('div');
          card.className = 'restaurant-card';
          card.innerHTML = `
            <img src="${r.image}" alt="${r.name}">
            <div class="info">
              <h3>${r.name}</h3>
              <p>${r.cuisine}</p>
              <p style='color:#ff6e30;font-weight:500;'>${dist.toFixed(1)} km away</p>
              <button class="btn w-100 mt-2" onclick="showMenu(${idx})">View Menu</button>
            </div>
          `;
          col.appendChild(card);
          list.appendChild(col);
        }
      });
    }

    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
      var R = 6371;
      var dLat = deg2rad(lat2-lat1);
      var dLon = deg2rad(lon2-lon1);
      var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }
  </script>
</body>
</html>
